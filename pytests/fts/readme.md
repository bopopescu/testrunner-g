##Full Text Search test framework overview
- 2 steps in any complete FTS test
  - index creation (default or customized) and
  - query phase (with result validation)
- 70% of FTS tests use the random map and/or query generation code.
- RQG is pluggable, currently works with 2 datasets - employee and wiki. More datasets can be supported by defining the "query-ables" for the same.
- Smart query enabled querying only on indexed and one/two non-indexed fields. Smart querying is also explained further below.


##Dataset loaders

Employee dataset loader is [here](https://github.com/couchbase/testrunner/blob/master/lib/couchbase_helper/documentgenerator.py#L221)
All fields for Employee dataset are randomly generated at runtime. RQG generates query predicates for emp dataset using the same logic.

Wiki(in 5 languages) loader(only generates 30K unique docs(>2.5K)) is [here](https://github.com/couchbase/testrunner/blob/master/lib/couchbase_helper/documentgenerator.py#L382). Wiki data files are uploaded to AWS. These files are automatically pulled by the doc-loader if found missing in the repo. For wiki dataset, RQG does not randomly generate search terms during runtime. There's a pre-saved file of query-ables obtained by scanning the docs, on which random queries are constructed.

##Random Query Generator(RQG) (code: cd random_query_generator)

Every dataset supported by fts tests must have the corresponding queryable.py defined. Queryables are queryable data for every field of the JSON dataset based on which a query predicate can be defined/constructed. Take a look at emp_queryables.py and wiki_queryables.py. rand_query_gen.py is the actual random query generator code.
- Not only generates FTS queries but also equivalent Elastic Search queries so results can be compared for correctness.
- Based on the dataset loaded, it generates a wide range of queries on all/subset of JSON fields. A subset of the following queries can also be generated by specifying the same using query_types param -
  - match
  - match_phrase
  - numeric range
  - date range
  - boolean
  - query-string-query
  - conjunction
  - disjunction
  - wildcard
  - regexp
  - prefix
  - fuzzy
- generates any number of queries based on passed parameter, num_queries.

So RQG is usually "plugged-in" in the following fashion -

    query_type=['match_phrase', 'match', 'date_range', 'numeric_range', 'bool',
                 'conjunction', 'disjunction', 'prefix']
    query_gen = FTSESQueryGenerator(num_queries=100, query_type=query_type, dataset='all')

## Random custom map generator (code : cd random_map_generator/)
- Depending on one or more datasets loaded, generates simple to complex custom index mapping based on a custom map id, which is passed in the test-case.
- Not only generates an FTS map, but also generates an equivalent Elastic Search mapping to create 2 comparable systems so queries can yield same results.
- feeds the query-able fields into RQG. This is called smart-querying. This especially makes sense in the context of custom maps so RQG doesn't keep generating queries on fields not indexed but instead focuses on indexed fields and 0-2 non-indexed fields(for negative testing).

## How to run fts tests
Running full-text tests using testrunner is quite simple -

1. Do a 'git pull' from inside your 'testrunner' directory. All tests are run from this directory.
If you are running testrunner for the first time and you are seeing error like "module or file not found", make sure you install the following -
    sudo easy_install pip
    sudo pip install paramiko
    sudo pip install httplib2
    sudo pip install urllib

2. For node/cluster config, make sure you have a .ini file in the testrunner dir which looks like

        [global]
        username:root
        password:couchbase
        port:8091

        [membase]
        rest_username:Administrator
        rest_password:password

        [servers]
        1:_1
        2:_2
        3:_3
        4:_4

        [elastic]
        ip:172.23.105.25
        port:9200

        [_1]
        ip:172.23.106.221
        services:kv

        [_2]
        ip:172.23.106.33

        [_3]
        ip:172.23.107.125

        [_4]
        ip:172.23.107.235


pls note, the [elastic] section is of no relevance if you are not verifying your results against an elastic search node. It can be skipped. Make sure the first node in the cluster is pre-configured with the required services, say kv,fts or only kv as required by the test.

For cluster-run, add in 127.0.0.1 and corresponding ports for Couchbase and FTS, for every instance. Your ini for cluster_run may want to look like -

    [global]
    username:root
    password:couchbase
    port:9000

    [membase]
    rest_username:Administrator
    rest_password:password

    [servers]
    1:_1
    2:_2
    3:_3

    [elastic]
    ip:10.3.4.191
    port:9200

    [_1]
    ip:127.0.0.1
    port:9000
    services:kv

    [_2]
    ip:127.0.0.1
    port:9001
    fts_port:9201

    [_3]
    ip:127.0.0.1
    port:9002
    fts_port:9202

Also it might be worth doing an enterprise build (BUILD_ENTERPRISE=1 make) to be able to cluster in node with select services.

3. All tests that have been developed so far are present in the conf/fts/*.conf files.

#####To run all tests in a conf file, run
./testrunner -i <your.ini> -c conf/fts/py-xxx.conf

#####To run a particular test,
./testrunner -i <your.ini> -t  fts.stable_topology_fts.StableTopFTS.create_simple_default_index,items=10,cluster=D,F

#####To run randomly generated queries(eg. disjunction) with validation against ES -
./testrunner -i cbft.ini -t fts.stable_topology_fts.StableTopFTS.test_query_type,items=1000,num_queries=13,query_types=disjunction,cluster=D,F,F,D+F,skip-cleanup=True,compare_es=True,kvstore=boltdb

#####Important params to pass
     - cluster = specifies number of nodes in the cluster with specific services. Eg., D, F means 1 data and 1 fts node. D,F,F,D+F means 4 node cluster with 1 kv+fts node, default: D, F, F
     - kvstore = boltdb/rocksdb/forestdb. default:forestdb.
     - items = no of keys to load, default: 1000
     - compare_es = True/False. Default: False, compare results with elastic search. Needs a valid ES instance running, specified in .ini file.
     - skip-cleanup = True/False. Default: False, to indicate bucket deletion and declustering of nodes post test run
     - update/delete = True/False, Default: False, indicates if the test has update/delete phase
     - expires = ttl for keys in secs, Default: 0
     - index_replicas = number of index replicas, default:None (product default)
     - max_partitions_pindex =max partitions per pindex, default:None (product default)
     - fdb_compact_interval = forestdb compaction interval in secs, defaults to None
     - fdb_compact_threshold = foresdb compaction threshold in %, defaults to None

More such params and default values can be found [here.](https://github.com/couchbase/testrunner/blob/master/pytests/fts/fts_base.py#L2104). See init_parameters() if line number does not match.

###Environment Variables

CBFT_ENV_OPTIONS=bleveMaxResultWindow=10000000,forestdbCompactorSleepDuration=180,forestdbCompactionThreshold=10

        bleveMaxResultWindow
          The max number of query results to request from FTS. Default is 10000.
          We do not expect to test > 10M in functional testing, so this has been set to 10M to request
          all results from FTS so the ES vs FTS comparison of the entire result-set can be done.
          This variable is passed at the time of installation using fts_query_limit=10000000

        forestdbCompactorSleepDuration
          Duration that the compaction daemon task periodically wakes up, in the unit of
          second. In testrunner, this variable can be passed from the testcase itself after installation
          using "fdb_compact_interval", in the unit of second.

        forestdbCompactionThreshold (uint8)
          Compaction threshold in the unit of percentage (%). Compaction will not be performed when this
          value is set to zero or 100. In testrunner, this variable can also be passed from the testcase itself
          after installation using "fdb_compact_threshold", in %.

A caveat on the forestdb settings-
Once set in a particular test,all subsequent tests that use kvstore=forestdb will run with the same forestdb settings
unless set again using the same params. Also, for these settings to take effect, make sure forestdb is the
default index store, by passing kvstore=forestdb in your testcase.

All environment variables only make sense to be set in a non cluster-run environment. In a cluster-run environment,
make sure couchbase-server is launched like -

        CBFT_ENV_OPTIONS=forestdbCompactorSleepDuration=120,forestdbNumCompactorThreads=8 \
        /opt/couchbase/bin/couchbase-server

###Choosing Storage engines
We have 2 options post 4.5.0 - forestdb and mossStore. In 4.5.0, the only supported engine was forestdb.
For spock builds, "mossStore" is currently the default engine. To toggle between storage engines in testcases,
use kvstore=forestdb/mossStore.

More on compaction of index files on these stores can be found [here](https://github.com/couchbase/cbft/blob/5357c43296c3d1241cc5e5cc9129fd9c381ede27/DESIGN-compaction.md)

###Where to add new tests
In this directory, you will find 4 .py files.
    1. fts_base.py - the base test class for FTS. You will find/add all basic methods required to frame the tests here.
        There are 4 important, useful classes here -
        a. CouchbaseCluster - deals with Cluster operations, keeps an account of nodes, hosts all
           Couchbase cluster operational methods like data-load, rebalance, failover etc.
        b. FTSIndex - contains methods to create, edit, delete indexes
        c. NodeHelper - contains methods that perform node-level operations like login and start/stop couchabse,
           kill processes, grep for something in fts logs etc.
        d. FTSBaseTestClass - the main base class that is inherited by other test-case hosting classes like StableTopFTS or MovingTopFTS,
           makes calls to all the above classes for setup, teardown, data-loading, index-creation, result validation etc.
    2. es_base.py - for working with ElasticSearch, will help with index creation, deletion, running queries, bulk api for data
       loading/updating/deletion
    3. stable_topology_fts.py - contains testcases that deal with plain indexing and querying with no topology changes at the cluster-level.
    4. moving_topology_fts.py - contains testcases that combine indexing/quering with special scenarios that involve cluster-ops like rebalance, failover,
       swap-rebalance, node-crash, process termination, node-reboots on a cluster hosting nodes running one or more services.
As a general rule, add callable testcases to stable_topology_fts.py or moving_topology_fts.py depending on the nature of the test and
if adding a reusable piece of code, move it to an appropriate class under fts_base.py